<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HQ Contracts - Intel v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        :root {
            --bg-deep: #020617;
            --panel-bg: rgba(15, 23, 42, 0.8);
            --accent: #6366f1;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-deep); color: #f8fafc; margin: 0; padding: 0; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .glow-button { box-shadow: 0 0 20px rgba(99, 102, 241, 0.2); transition: all 0.2s ease; cursor: pointer; }
        .glow-button:hover { box-shadow: 0 0 30px rgba(99, 102, 241, 0.4); transform: translateY(-1px); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .alert-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        button, .filter-btn { cursor: pointer; user-select: none; }
    </style>
</head>
<body class="min-h-screen custom-scroll overflow-x-hidden">

    <!-- Header Navigation -->
    <header class="sticky top-0 z-[60] glass-panel border-b border-white/5 px-4 md:px-8 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3 md:gap-4">
            <i class="fas fa-microchip text-indigo-500 text-2xl md:text-3xl"></i>
            <div>
                <h1 class="text-lg md:text-xl font-black tracking-tighter uppercase italic leading-none">FIN-INTEL <span class="text-indigo-400">v4.0</span></h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="sync-dot" class="w-1.5 h-1.5 rounded-full bg-slate-500"></span>
                    <p id="sync-text" class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Initializing...</p>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2 md:gap-3">
            <button id="btn-export" class="hidden md:flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                <i class="fas fa-file-export"></i> Export
            </button>
            <button id="btn-new-entry" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 md:px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all glow-button">
                <i class="fas fa-plus"></i> New Entry
            </button>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto p-4 md:p-10 space-y-6 md:space-y-10">
        <!-- Analytics Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
            <div class="glass-panel p-6 rounded-[1.5rem]">
                <p class="text-[10px] uppercase font-black text-slate-500 tracking-widest mb-1">Total Value</p>
                <h3 id="stat-total" class="text-2xl md:text-3xl font-black tracking-tighter">$0</h3>
            </div>
            
            <div class="glass-panel p-6 rounded-[1.5rem] border-l-4 border-l-emerald-500">
                <p class="text-[10px] uppercase font-black text-slate-500 tracking-widest mb-1">Recovered Liquidity</p>
                <h3 id="stat-paid" class="text-2xl md:text-3xl font-black tracking-tighter text-emerald-400">$0</h3>
                <div class="mt-4 bg-slate-800/50 h-1.5 rounded-full overflow-hidden">
                    <div id="liquidity-bar" class="bg-emerald-500 h-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>

            <div id="alert-container" class="md:col-span-2 glass-panel p-6 rounded-[1.5rem] flex flex-col justify-between border border-white/5 transition-all">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[10px] uppercase font-black text-slate-500 tracking-widest">Database Pulse</p>
                        <h3 id="stat-count" class="text-xl md:text-2xl font-black italic">0 Records</h3>
                    </div>
                    <div id="expiry-alerts" class="flex flex-col gap-2 items-end"></div>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
            <div class="relative w-full lg:w-1/2">
                <i class="fas fa-search absolute left-6 top-1/2 -translate-y-1/2 text-slate-500"></i>
                <input id="search-input" type="text" placeholder="Scan Customer, Company, CR..." class="w-full bg-slate-900/50 border border-white/5 rounded-2xl py-4 pl-14 pr-6 focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-sm">
            </div>
            <div id="filter-group" class="flex bg-slate-900/50 p-1 rounded-2xl border border-white/5 overflow-x-auto">
                <button data-filter="all" class="filter-btn px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-indigo-600 text-white">All</button>
                <button data-filter="Paid" class="filter-btn px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-slate-400 hover:text-white">Paid</button>
                <button data-filter="Pending" class="filter-btn px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-slate-400 hover:text-white">Pending</button>
                <button data-filter="Expiring" class="filter-btn px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-slate-400 hover:text-white">Expiring</button>
            </div>
        </div>

        <!-- Registry Table -->
        <div class="glass-panel rounded-[1.5rem] overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-900/80 text-[10px] uppercase font-black text-slate-500 tracking-widest border-b border-white/5">
                        <tr>
                            <th class="px-8 py-6">Record Identity</th>
                            <th class="px-8 py-6">Timeline</th>
                            <th class="px-8 py-6 hidden md:table-cell">Activity</th>
                            <th class="px-8 py-6 text-right">Payment</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-white/5">
                        <tr><td colspan="4" class="py-20 text-center text-slate-600 font-black uppercase text-[10px] tracking-widest">Awakening Systems...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[100] hidden items-center justify-center p-4 overflow-y-auto">
        <div class="bg-[#0f172a] w-full max-w-4xl rounded-[2.5rem] border border-white/10 p-8 shadow-2xl relative">
            <button id="modal-close" class="absolute top-6 right-6 text-slate-500 hover:text-white p-2 transition-colors"><i class="fas fa-times text-xl"></i></button>
            <h2 id="modal-title" class="text-xl font-black uppercase tracking-tighter mb-8 italic">New Intel Record</h2>
            <form id="intel-form" class="space-y-6">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Company</label><input id="f-company" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Customer</label><input id="f-customer" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Customer ID</label><input id="f-cust-num" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Start Date</label><input type="date" id="f-start" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">End Date</label><input type="date" id="f-end" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Month</label><input id="f-pay-month" placeholder="e.g. October 2023" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">CR Number</label><input id="f-cr" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Tax ID</label><input id="f-tax" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Ref</label><input id="f-ref" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Amount ($)</label><input type="number" step="0.01" id="f-payment" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Activity</label><input id="f-activity" required class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"></div>
                    <div class="space-y-2"><label class="text-[9px] font-black uppercase text-slate-500 tracking-widest ml-1">Status</label><select id="f-status" class="w-full bg-slate-900 border border-white/5 rounded-xl p-4 text-sm focus:border-indigo-500 outline-none"><option value="Pending">Pending</option><option value="Paid">Paid</option></select></div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 pt-6">
                    <button type="button" id="modal-cancel" class="flex-1 bg-slate-800 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest">Cancel</button>
                    <button type="submit" class="flex-[2] bg-indigo-600 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest glow-button">Sync Record</button>
                    <button type="button" id="delete-btn" class="hidden bg-red-500/10 text-red-500 border border-red-500/20 px-6 py-4 rounded-xl hover:bg-red-500/30 transition-all"><i class="fas fa-trash"></i></button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hq-contracts-intel';
        
        let registry = [];
        let currentFilter = 'all';
        let currentUser = null;

        // UI Helpers
        const setStatus = (txt, color) => {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-text');
            dot.className = `w-1.5 h-1.5 rounded-full ${color}`;
            status.innerText = txt;
        };

        const checkExpiry = (date) => {
            if (!date) return false;
            const end = new Date(date);
            const now = new Date();
            const diff = (end - now) / (1000 * 60 * 60 * 24);
            return diff >= 0 && diff <= 7;
        };

        const render = () => {
            const table = document.getElementById('table-body');
            const search = document.getElementById('search-input').value.toLowerCase();
            
            const filtered = registry.filter(r => {
                const match = (r.customer + r.company + r.cr + r.ref).toLowerCase().includes(search);
                if (currentFilter === 'all') return match;
                if (currentFilter === 'Expiring') return match && checkExpiry(r.end);
                return match && r.status === currentFilter;
            });

            if (!filtered.length) {
                table.innerHTML = `<tr><td colspan="4" class="py-20 text-center text-slate-600 font-black uppercase text-[10px] tracking-widest">No signals found</td></tr>`;
                return;
            }

            table.innerHTML = filtered.map(r => {
                const exp = checkExpiry(r.end);
                return `
                    <tr class="row-edit group cursor-pointer hover:bg-white/[0.02] border-b border-white/5" data-id="${r.id}">
                        <td class="px-8 py-6">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 ${exp ? 'bg-red-500/20 text-red-400' : 'bg-slate-800 text-slate-500'} rounded-xl flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-all">
                                    <i class="fas ${exp ? 'fa-clock' : 'fa-folder'}"></i>
                                </div>
                                <div>
                                    <p class="text-xs font-black text-white">${r.customer}</p>
                                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-tighter">${r.company}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-8 py-6">
                            <p class="text-[10px] font-black ${exp ? 'text-red-400' : 'text-indigo-400'} uppercase tracking-widest">${r.month}</p>
                            <p class="text-[8px] text-slate-500 uppercase font-bold mt-1">End: ${r.end}</p>
                        </td>
                        <td class="px-8 py-6 hidden md:table-cell">
                            <p class="text-[10px] font-bold text-slate-300 uppercase">${r.activity}</p>
                            <p class="text-[8px] text-slate-500 font-mono mt-1">REF: ${r.ref}</p>
                        </td>
                        <td class="px-8 py-6 text-right">
                            <p class="font-black text-sm">$${parseFloat(r.payment).toLocaleString()}</p>
                            <span class="text-[7px] font-black uppercase px-2 py-0.5 rounded ${r.status === 'Paid' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-amber-500/10 text-amber-400'}">
                                ${r.status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');

            document.querySelectorAll('.row-edit').forEach(el => {
                el.onclick = () => open(el.dataset.id);
            });
        };

        const updateUI = () => {
            const total = registry.reduce((s, r) => s + (parseFloat(r.payment) || 0), 0);
            const paid = registry.filter(r => r.status === 'Paid').reduce((s, r) => s + (parseFloat(r.payment) || 0), 0);
            const alerts = registry.filter(r => checkExpiry(r.end)).length;

            document.getElementById('stat-total').innerText = `$${total.toLocaleString()}`;
            document.getElementById('stat-paid').innerText = `$${paid.toLocaleString()}`;
            document.getElementById('stat-count').innerText = `${registry.length} Records`;
            document.getElementById('liquidity-bar').style.width = `${total ? (paid/total)*100 : 0}%`;

            const alertBox = document.getElementById('expiry-alerts');
            if (alerts > 0) {
                alertBox.innerHTML = `<div class="bg-red-500 text-white px-3 py-1 rounded text-[8px] font-black uppercase alert-pulse">${alerts} Critical Expiries</div>`;
            } else {
                alertBox.innerHTML = `<div class="bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded text-[8px] font-black uppercase border border-emerald-500/20">System Nominal</div>`;
            }
            render();
        };

        const open = (id = null) => {
            const modal = document.getElementById('modal');
            const form = document.getElementById('intel-form');
            form.reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('delete-btn').classList.add('hidden');
            
            if (id) {
                const r = registry.find(x => x.id === id);
                if (r) {
                    document.getElementById('edit-id').value = r.id;
                    document.getElementById('f-company').value = r.company;
                    document.getElementById('f-customer').value = r.customer;
                    document.getElementById('f-cust-num').value = r.cust_num;
                    document.getElementById('f-start').value = r.start;
                    document.getElementById('f-end').value = r.end;
                    document.getElementById('f-pay-month').value = r.month;
                    document.getElementById('f-cr').value = r.cr;
                    document.getElementById('f-tax').value = r.tax;
                    document.getElementById('f-ref').value = r.ref;
                    document.getElementById('f-payment').value = r.payment;
                    document.getElementById('f-activity').value = r.activity;
                    document.getElementById('f-status').value = r.status;
                    document.getElementById('delete-btn').classList.remove('hidden');
                }
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const close = () => {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        };

        // Event Listeners - Direct Bindings
        document.getElementById('btn-new-entry').onclick = () => open();
        document.getElementById('modal-close').onclick = close;
        document.getElementById('modal-cancel').onclick = close;
        document.getElementById('search-input').oninput = render;

        document.getElementById('intel-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            setStatus('Syncing...', 'bg-amber-500 animate-pulse');
            
            const id = document.getElementById('edit-id').value || crypto.randomUUID();
            const data = {
                id,
                company: document.getElementById('f-company').value,
                customer: document.getElementById('f-customer').value,
                cust_num: document.getElementById('f-cust-num').value,
                start: document.getElementById('f-start').value,
                end: document.getElementById('f-end').value,
                month: document.getElementById('f-pay-month').value,
                cr: document.getElementById('f-cr').value,
                tax: document.getElementById('f-tax').value,
                ref: document.getElementById('f-ref').value,
                payment: parseFloat(document.getElementById('f-payment').value) || 0,
                activity: document.getElementById('f-activity').value,
                status: document.getElementById('f-status').value,
                updated: Date.now()
            };

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'contracts', id), data);
                close();
            } catch (err) { console.error(err); }
        };

        document.getElementById('delete-btn').onclick = async () => {
            const id = document.getElementById('edit-id').value;
            if (id && confirm('Purge record?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'contracts', id));
                close();
            }
        };

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.onclick = () => {
                currentFilter = btn.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.className = `filter-btn px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${currentFilter === b.dataset.filter ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'}`;
                });
                render();
            };
        });

        document.getElementById('btn-export').onclick = () => {
            if (!registry.length) return;
            const headers = "Customer,Company,Month,End,Amount,Status\n";
            const csv = headers + registry.map(r => `"${r.customer}","${r.company}","${r.month}","${r.end}",${r.payment},"${r.status}"`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HQ_Intel_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };

        // Lifecycle
        onAuthStateChanged(auth, u => {
            currentUser = u;
            if (u) {
                setStatus('Cloud Secure', 'bg-emerald-500');
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'contracts'), s => {
                    registry = s.docs.map(d => d.data());
                    updateUI();
                });
            }
        });

        const start = async () => {
            setStatus('Connecting...', 'bg-amber-500 animate-pulse');
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        start();
    </script>
</body>
</html>